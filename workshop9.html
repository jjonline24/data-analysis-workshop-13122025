<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop 9: Cohort Analysis (Retention Rate)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≤‡∏ü‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .shadow-sm, .shadow-md { box-shadow: none !important; }
        }
        /* Heatmap cell coloring classes */
        .bg-retention-0 { background-color: #ffffff; color: #cbd5e1; }
        .bg-retention-1 { background-color: #eff6ff; color: #1e3a8a; } /* 0-20% */
        .bg-retention-2 { background-color: #dbeafe; color: #1e3a8a; } /* 20-40% */
        .bg-retention-3 { background-color: #bfdbfe; color: #1e3a8a; } /* 40-60% */
        .bg-retention-4 { background-color: #93c5fd; color: #1e40af; } /* 60-80% */
        .bg-retention-5 { background-color: #60a5fa; color: #ffffff; } /* 80-100% */
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-500">
            <div>
                <h1 class="text-2xl font-bold text-indigo-700">üìä Workshop 9: Cohort Analysis</h1>
                <p class="text-slate-500 text-sm mt-1">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Retention Rate ‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (Cohort) ‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <p class="text-sm font-semibold text-slate-600">Goal: ‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏±‡πà‡∏á‡∏¢‡∏∑‡∏ô‡∏Ç‡∏≠‡∏á‡∏ê‡∏≤‡∏ô‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</p>
                <p class="text-xs text-slate-400">‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏à‡∏≤‡∏Å Workshop 8 & 9</p>
            </div>
        </header>

        <!-- Workshop Objectives Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Card 1: ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 bg-blue-100 rounded-lg text-blue-600">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h3 class="font-bold text-slate-700">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥</h3>
                </div>
                <ul class="text-sm text-slate-600 space-y-2 list-disc list-inside">
                    <li>‡∏Å‡∏≥‡∏´‡∏ô‡∏î <strong>Cohort Month</strong> (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ã‡∏∑‡πâ‡∏≠)</li>
                    <li>‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥</li>
                    <li>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì <strong>Retention Rate (%)</strong></li>
                </ul>
            </div>

            <!-- Card 2: ‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 bg-purple-100 rounded-lg text-purple-600">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="font-bold text-slate-700">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h3>
                </div>
                <p class="text-sm text-slate-600">
                    ‡∏™‡∏£‡πâ‡∏≤‡∏á <strong>Pivot Table</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥‡πÉ‡∏ô Month 1, Month 2, ... ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Month 0)
                </p>
            </div>

            <!-- Card 3: ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="p-2 bg-emerald-100 rounded-lg text-emerald-600">
                        <i class="fas fa-flag-checkered"></i>
                    </div>
                    <h3 class="font-bold text-slate-700">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö</h3>
                </div>
                <ul class="text-sm text-slate-600 space-y-2 list-disc list-inside">
                    <li>‡∏ï‡∏≤‡∏£‡∏≤‡∏á Cohort Analysis (Heatmap)</li>
                    <li>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Key Findings ‡πÅ‡∏•‡∏∞ Insight</li>
                    <li>‡πÑ‡∏ü‡∏•‡πå Export CSV ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô PDF</li>
                </ul>
            </div>
        </div>

        <!-- Input Section -->
        <div class="bg-white p-6 rounded-xl shadow-sm no-print">
            <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                <i class="fas fa-file-csv mr-2 text-indigo-500"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Upload CSV)
            </h2>
            
            <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition-colors cursor-pointer" id="dropZone">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <div class="space-y-3">
                    <i class="fas fa-cloud-upload-alt text-4xl text-slate-400"></i>
                    <p class="text-slate-600 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    <p class="text-xs text-slate-400">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: cleaned_sales.csv (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ Customer_ID ‡πÅ‡∏•‡∏∞ Date)</p>
                </div>
            </div>
            <div id="fileInfo" class="mt-3 text-sm text-emerald-600 hidden font-medium flex items-center justify-center">
                <i class="fas fa-check-circle mr-2"></i> <span id="fileNameDisplay"></span>
            </div>
        </div>

        <!-- Analysis Section: Cohort Table -->
        <div id="analysisSection" class="hidden space-y-6">
            
            <!-- Cohort Table Card -->
            <div class="bg-white p-6 rounded-xl shadow-sm overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-lg font-bold text-slate-800 border-l-4 border-indigo-500 pl-3">
                        ‡∏ï‡∏≤‡∏£‡∏≤‡∏á Cohort Analysis (Retention Rate %)
                    </h2>
                    <span class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full">
                        <i class="fas fa-users mr-1"></i> Unique Customers
                    </span>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-600" id="cohortTable">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 rounded-tl-lg">Cohort Month</th>
                                <th class="px-4 py-3">Users</th>
                                <!-- Dynamic Months Columns will be added here -->
                            </tr>
                        </thead>
                        <tbody id="cohortTableBody">
                            <!-- Rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Summary & Insights -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Summary Stats -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">
                        <i class="fas fa-search-dollar mr-2 text-blue-500"></i>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Summary)
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <span class="text-slate-600">Total Unique Customers</span>
                            <span id="summaryTotalCustomers" class="font-bold text-indigo-600 text-lg">-</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <span class="text-slate-600">Average Month 1 Retention</span>
                            <span id="summaryAvgRetentionM1" class="font-bold text-emerald-600 text-lg">-</span>
                        </div>
                         <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                            <span class="text-slate-600">Best Retention Cohort</span>
                            <span id="summaryBestCohort" class="font-bold text-purple-600 text-lg">-</span>
                        </div>
                    </div>
                </div>

                <!-- Key Findings -->
                <div class="bg-white p-6 rounded-xl shadow-sm">
                    <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">
                        <i class="fas fa-lightbulb mr-2 text-amber-500"></i>‡∏Ç‡πâ‡∏≠‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏´‡∏•‡∏±‡∏Å (Key Findings)
                    </h3>
                    <ul id="keyFindingsList" class="space-y-3 text-sm text-slate-600 list-disc list-inside">
                        <li>‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</li>
                    </ul>
                </div>
            </div>

        </div>

        <!-- Action Buttons -->
        <div class="flex flex-col md:flex-row gap-4 mt-8 no-print justify-end pb-8">
            <button onclick="printReport()" class="flex-1 md:flex-none px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-medium transition-colors flex items-center justify-center">
                <i class="fas fa-print mr-2"></i> Print Report
            </button>
            <button onclick="exportToCSV()" class="flex-1 md:flex-none px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition-colors flex items-center justify-center shadow-lg shadow-indigo-200">
                <i class="fas fa-file-export mr-2"></i> Export CSV
            </button>
        </div>

    </div>

    <!-- Scripts -->
    <script>
        // --- 1. MOCK DATA (10 Rows for Layout Testing) ---
        const mockDataRaw = `
TXN-001,15/01/2024,C-001,Sports,1000,Bangkok
TXN-002,20/02/2024,C-001,Sports,1000,Bangkok
TXN-003,15/01/2024,C-002,Electronics,2000,Chonburi
TXN-004,10/02/2024,C-003,Fashion,1500,Phuket
TXN-005,15/03/2024,C-001,Sports,1000,Bangkok
TXN-006,20/03/2024,C-002,Electronics,2000,Chonburi
TXN-007,05/03/2024,C-004,Home,3000,Chiang Mai
TXN-008,12/03/2024,C-003,Fashion,1500,Phuket
TXN-009,01/04/2024,C-005,Beauty,500,Bangkok
TXN-010,20/04/2024,C-001,Sports,1000,Bangkok
`.trim();

        let globalCohortData = null;

        // --- 2. LOGIC: Parse & Process ---
        
        function parseCSVLine(line) {
            // Assumes format: ID, Date(dd/mm/yyyy), CustomerID, Category, Sales, Region
            const parts = line.split(',');
            if (parts.length < 3) return null;
            return {
                txnId: parts[0].trim(),
                dateStr: parts[1].trim(),
                customerId: parts[2].trim(),
                category: parts[3]?.trim(),
                amount: parseFloat(parts[4] || 0),
                region: parts[5]?.trim()
            };
        }

        function parseDate(dateStr) {
            // Format DD/MM/YYYY
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }

        function processData(csvText, sourceName) {
            const lines = csvText.split('\n');
            const transactions = [];

            // Skip header if present (check if first line has 'Transaction_ID')
            let startIndex = 0;
            if (lines[0].toLowerCase().includes('transaction_id')) startIndex = 1;

            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const txn = parseCSVLine(line);
                if (txn && txn.customerId && txn.dateStr) {
                    transactions.push(txn);
                }
            }

            if (transactions.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV");
                return;
            }

            // 1. Find Cohort Month for each customer
            const customerCohorts = {}; // { customerId: Date(FirstPurchase) }
            
            transactions.forEach(txn => {
                const date = parseDate(txn.dateStr);
                if (!date) return;
                
                if (!customerCohorts[txn.customerId] || date < customerCohorts[txn.customerId]) {
                    customerCohorts[txn.customerId] = date;
                }
            });

            // 2. Assign transactions to Cohort Buckets
            // Data Structure: { 'YYYY-MM': { size: 0, customers: Set, retention: { 0: Set, 1: Set... } } }
            const cohorts = {};
            let maxMonthIndex = 0;

            transactions.forEach(txn => {
                const custId = txn.customerId;
                const txnDate = parseDate(txn.dateStr);
                if (!txnDate) return;

                const firstDate = customerCohorts[custId];
                
                // Key for Cohort: YYYY-MM
                const cohortKey = `${firstDate.getFullYear()}-${String(firstDate.getMonth() + 1).padStart(2, '0')}`;
                
                // Initialize Cohort if not exists
                if (!cohorts[cohortKey]) {
                    cohorts[cohortKey] = {
                        monthStr: cohortKey,
                        firstDateObj: firstDate, // for sorting
                        customers: new Set(),
                        retention: {}
                    };
                }

                // Add to Cohort Population
                cohorts[cohortKey].customers.add(custId);

                // Calculate Month Index (0, 1, 2...)
                // Formula: (YearDiff * 12) + MonthDiff
                const yearDiff = txnDate.getFullYear() - firstDate.getFullYear();
                const monthDiff = txnDate.getMonth() - firstDate.getMonth();
                const monthIndex = (yearDiff * 12) + monthDiff;

                if (monthIndex >= 0) {
                    if (!cohorts[cohortKey].retention[monthIndex]) {
                        cohorts[cohortKey].retention[monthIndex] = new Set();
                    }
                    cohorts[cohortKey].retention[monthIndex].add(custId);
                    if (monthIndex > maxMonthIndex) maxMonthIndex = monthIndex;
                }
            });

            // Sort Cohorts by Date
            const sortedCohorts = Object.values(cohorts).sort((a, b) => a.firstDateObj - b.firstDateObj);

            globalCohortData = { sortedCohorts, maxMonthIndex, totalCustomers: Object.keys(customerCohorts).length };
            
            renderCohortTable(globalCohortData);
            generateInsights(globalCohortData);
            
            // Show Analysis Section
            document.getElementById('analysisSection').classList.remove('hidden');
            if(sourceName) {
                document.getElementById('fileNameDisplay').textContent = sourceName;
                document.getElementById('fileInfo').classList.remove('hidden');
            }
        }

        // --- 3. RENDERING ---

        function getRetentionColor(percentage) {
            if (percentage === 0) return 'bg-retention-0';
            if (percentage <= 20) return 'bg-retention-1';
            if (percentage <= 40) return 'bg-retention-2';
            if (percentage <= 60) return 'bg-retention-3';
            if (percentage <= 80) return 'bg-retention-4';
            return 'bg-retention-5';
        }

        function renderCohortTable(data) {
            const tableHeadRow = document.querySelector('#cohortTable thead tr');
            const tableBody = document.querySelector('#cohortTableBody');

            // Reset headers (keep first two)
            while (tableHeadRow.children.length > 2) {
                tableHeadRow.removeChild(tableHeadRow.lastChild);
            }
            
            // Add Month Headers (Month 0 to Max)
            for (let i = 0; i <= data.maxMonthIndex; i++) {
                const th = document.createElement('th');
                th.className = "px-4 py-3 text-center";
                th.textContent = i === 0 ? "Month 0" : `+${i} Month`;
                tableHeadRow.appendChild(th);
            }

            // Render Body
            tableBody.innerHTML = '';
            
            data.sortedCohorts.forEach(cohort => {
                const tr = document.createElement('tr');
                tr.className = "bg-white border-b hover:bg-slate-50 transition-colors";

                const cohortSize = cohort.customers.size;

                // Col 1: Cohort Month
                const tdMonth = document.createElement('td');
                tdMonth.className = "px-4 py-3 font-medium text-slate-800 whitespace-nowrap";
                tdMonth.textContent = cohort.monthStr;
                tr.appendChild(tdMonth);

                // Col 2: Users Count
                const tdUsers = document.createElement('td');
                tdUsers.className = "px-4 py-3 font-semibold text-indigo-600";
                tdUsers.textContent = cohortSize.toLocaleString();
                tr.appendChild(tdUsers);

                // Col 3+: Retention Columns
                for (let i = 0; i <= data.maxMonthIndex; i++) {
                    const td = document.createElement('td');
                    td.className = "px-2 py-3 text-center border-l border-slate-100";
                    
                    const retainedSet = cohort.retention[i];
                    const retainedCount = retainedSet ? retainedSet.size : 0;
                    
                    let percentage = 0;
                    if (cohortSize > 0) {
                        percentage = Math.round((retainedCount / cohortSize) * 100);
                    }

                    // Only show data if retention exists or it's Month 0 (always 100%) or previous months had data
                    // Simple logic: show all 0% if timeline passed.
                    // For visualization, we just show the calculated %.
                    
                    const colorClass = getRetentionColor(percentage);
                    
                    // Create inner badge
                    const badge = document.createElement('div');
                    badge.className = `w-full h-8 flex items-center justify-center rounded text-xs font-bold ${colorClass}`;
                    badge.textContent = percentage + '%';
                    
                    // Tooltip logic could be here (showing raw count)
                    badge.title = `${retainedCount} users`;

                    td.appendChild(badge);
                    tr.appendChild(td);
                }
                tableBody.appendChild(tr);
            });
        }

        function generateInsights(data) {
            // 1. Total Unique Customers
            document.getElementById('summaryTotalCustomers').textContent = data.totalCustomers.toLocaleString();

            // 2. Avg Retention Month 1
            let totalM1Percent = 0;
            let countM1 = 0;
            let bestCohort = { month: '-', rate: -1 };

            data.sortedCohorts.forEach(cohort => {
                const size = cohort.customers.size;
                // Month 1
                if (cohort.retention[1]) {
                    const m1Count = cohort.retention[1].size;
                    const rate = (m1Count / size) * 100;
                    totalM1Percent += rate;
                    countM1++;

                    if (rate > bestCohort.rate) {
                        bestCohort.rate = rate;
                        bestCohort.month = cohort.monthStr;
                    }
                } else if (data.maxMonthIndex >= 1) {
                    // Cohort existed but 0 retention in M1
                     countM1++; // include in average as 0? Typically yes if cohort is old enough. 
                     // Simplified: Only counting cohorts that strictly have data or are old enough. 
                     // For mock, we'll assume 0 if undefined but not checking cohort age vs current date deeply.
                }
            });

            const avgM1 = countM1 > 0 ? (totalM1Percent / countM1).toFixed(1) + '%' : 'N/A';
            document.getElementById('summaryAvgRetentionM1').textContent = avgM1;
            document.getElementById('summaryBestCohort').textContent = bestCohort.month !== '-' ? `${bestCohort.month} (${bestCohort.rate.toFixed(0)}%)` : '-';

            // 3. Key Findings List
            const findingsList = document.getElementById('keyFindingsList');
            findingsList.innerHTML = '';
            
            const addFinding = (text, iconClass="fas fa-angle-right text-indigo-500") => {
                const li = document.createElement('li');
                li.innerHTML = `<i class="${iconClass} mr-2"></i>${text}`;
                findingsList.appendChild(li);
            };

            addFinding(`‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${data.totalCustomers}</strong> ‡∏£‡∏≤‡∏¢ ‡πÅ‡∏ö‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô <strong>${data.sortedCohorts.length}</strong> ‡∏Å‡∏•‡∏∏‡πà‡∏° Cohort`);
            
            if (avgM1 !== 'N/A') {
                addFinding(`‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≤‡∏£‡∏ã‡∏∑‡πâ‡∏≠‡∏ã‡πâ‡∏≥‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (Month 1) ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà <strong>${avgM1}</strong>`);
            } else {
                addFinding(`‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Retention ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1`);
            }

            if (bestCohort.rate > 0) {
                addFinding(`Cohort ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <strong>${bestCohort.month}</strong> (Retention M1: ${bestCohort.rate.toFixed(0)}%)`);
            }

            // Simple Pattern Detection
            const lastCohort = data.sortedCohorts[data.sortedCohorts.length - 1];
            addFinding(`Cohort ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (${lastCohort.monthStr}) ‡∏°‡∏µ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà <strong>${lastCohort.customers.size}</strong> ‡∏£‡∏≤‡∏¢`);
        }

        // --- 4. EXPORT & PRINT ---

        function exportToCSV() {
            if (!globalCohortData) return;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Header
            let header = ["Cohort Month", "Total Users"];
            for (let i = 0; i <= globalCohortData.maxMonthIndex; i++) {
                header.push(`Month +${i}`);
            }
            csvContent += header.join(",") + "\r\n";

            // Rows
            globalCohortData.sortedCohorts.forEach(cohort => {
                let row = [cohort.monthStr, cohort.customers.size];
                for (let i = 0; i <= globalCohortData.maxMonthIndex; i++) {
                    const count = cohort.retention[i] ? cohort.retention[i].size : 0;
                    const pct = cohort.customers.size > 0 ? (count / cohort.customers.size) * 100 : 0;
                    row.push(`${pct.toFixed(2)}%`);
                }
                csvContent += row.join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "cohort_analysis_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printReport() {
            window.print();
        }

        // --- 5. INITIALIZATION & EVENTS ---
        
        // Drag & Drop
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('csvFileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('bg-indigo-50', 'border-indigo-400');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('bg-indigo-50', 'border-indigo-400');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('bg-indigo-50', 'border-indigo-400');
            const files = e.dataTransfer.files;
            if (files.length) handleFile(files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            if (fileInput.files.length) handleFile(fileInput.files[0]);
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                processData(e.target.result, file.name);
            };
            reader.readAsText(file);
        }

        // Load Mock Data on Start
        window.addEventListener('DOMContentLoaded', () => {
            // Using the 10-row Mock Data as requested for initial view
            processData(mockDataRaw, 'Mock Data (10 Rows)');
        });

    </script>
</body>
</html>
