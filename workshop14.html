<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop 14: Executive Sales Report 2024</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Google Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Phosphor Icons (for icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        
        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background-color: white; }
            .shadow-sm { box-shadow: none !important; border: 1px solid #eee; }
            .chart-container { break-inside: avoid; page-break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-600">
            <div>
                <h1 class="text-2xl font-bold text-indigo-900">Executive Sales Report 2024</h1>
                <p class="text-slate-500 text-sm mt-1">Workshop 14: Single Figure with Subplots Dashboard</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <p class="text-xs text-slate-400">Generated on</p>
                <p class="font-medium text-slate-700" id="currentDate">-</p>
            </div>
        </header>

        <!-- Workshop Info Section (Grid) -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 no-print">
            <!-- Card 1: To Do -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center gap-2 mb-3 text-indigo-600">
                    <i class="ph ph-list-checks text-xl"></i>
                    <h3 class="font-bold text-lg">สิ่งที่ต้องทำ (To Do)</h3>
                </div>
                <ul class="text-sm text-slate-600 list-disc list-inside space-y-1">
                    <li>รวบรวมข้อมูล Transaction และ Customer</li>
                    <li>เตรียมข้อมูลสำหรับสร้าง 4 แผนภูมิหลัก</li>
                    <li>ออกแบบ Layout แบบ Single Figure</li>
                    <li>สร้าง Interactive Dashboard</li>
                </ul>
            </div>

            <!-- Card 2: Analysis -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center gap-2 mb-3 text-rose-500">
                    <i class="ph ph-trend-up text-xl"></i>
                    <h3 class="font-bold text-lg">การวิเคราะห์ (Analysis)</h3>
                </div>
                <ul class="text-sm text-slate-600 list-disc list-inside space-y-1">
                    <li>แนวโน้มยอดขายรวมรายเดือน (Line)</li>
                    <li>สัดส่วนยอดขายรายภาค (Pie)</li>
                    <li>สินค้าขายดี Top 5 (Bar)</li>
                    <li>การกระจายตัวยอดซื้อต่อบิล (Histogram)</li>
                </ul>
            </div>

            <!-- Card 3: Deliverables -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center gap-2 mb-3 text-emerald-600">
                    <i class="ph ph-file-doc text-xl"></i>
                    <h3 class="font-bold text-lg">ผลลัพธ์ (Deliverables)</h3>
                </div>
                <ul class="text-sm text-slate-600 list-disc list-inside space-y-1">
                    <li>หน้า Dashboard สรุปผลแผ่นเดียว</li>
                    <li>รายงาน Executive Report 2024</li>
                    <li>ไฟล์ Export CSV สำหรับทีม Data</li>
                    <li>ฟังก์ชันพิมพ์รายงาน PDF</li>
                </ul>
            </div>
        </section>

        <!-- Control Panel: Upload Only -->
        <section class="bg-white p-6 rounded-xl shadow-sm no-print">
            <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                <i class="ph ph-upload-simple"></i> นำเข้าข้อมูล (Import Data)
            </h2>
            
            <div class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center hover:bg-slate-50 transition-colors">
                <input type="file" id="csvInput" accept=".csv" class="hidden">
                <label for="csvInput" class="cursor-pointer flex flex-col items-center justify-center gap-2">
                    <div class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center">
                        <i class="ph ph-file-csv text-2xl"></i>
                    </div>
                    <span class="text-indigo-600 font-semibold text-lg hover:underline">คลิกเพื่ออัปโหลดไฟล์ CSV</span>
                    <span class="text-slate-400 text-sm">รองรับไฟล์ workshop3_processed หรือ cleaned_sales</span>
                </label>
            </div>
            <div class="mt-4 flex justify-between items-center">
                <p class="text-xs text-slate-400">*ระบบจะใช้ข้อมูลตัวอย่าง 10 แถว หากยังไม่ได้อัปโหลดไฟล์</p>
                <button onclick="resetData()" class="text-sm text-red-500 hover:text-red-700 font-medium">รีเซ็ตข้อมูล</button>
            </div>
        </section>

        <!-- Dashboard Charts Area -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Chart 1: Monthly Sales (Line) -->
            <div class="bg-white p-6 rounded-xl shadow-sm chart-container">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-blue-500 rounded-sm"></span> 
                    1. ยอดขายรวมรายเดือน
                </h3>
                <div class="relative h-64 md:h-72 w-full">
                    <canvas id="monthlyChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Sales by Region (Pie) -->
            <div class="bg-white p-6 rounded-xl shadow-sm chart-container">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-rose-500 rounded-sm"></span> 
                    2. สัดส่วนยอดขายตาม Region
                </h3>
                <div class="relative h-64 md:h-72 w-full flex justify-center">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>

            <!-- Chart 3: Top 5 Products (Bar) -->
            <div class="bg-white p-6 rounded-xl shadow-sm chart-container">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-amber-500 rounded-sm"></span> 
                    3. สินค้าขายดี 5 อันดับแรก
                </h3>
                <div class="relative h-64 md:h-72 w-full">
                    <canvas id="productChart"></canvas>
                </div>
            </div>

            <!-- Chart 4: Purchase Amount Distribution (Histogram) -->
            <div class="bg-white p-6 rounded-xl shadow-sm chart-container">
                <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <span class="w-2 h-6 bg-purple-500 rounded-sm"></span> 
                    4. การกระจายตัวของยอดซื้อต่อบิล
                </h3>
                <div class="relative h-64 md:h-72 w-full">
                    <canvas id="histogramChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary & Insights Section -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Summary -->
            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-indigo-500">
                <h3 class="font-bold text-lg text-slate-800 mb-3">
                    <i class="ph ph-chart-polar text-indigo-600 mr-1"></i> สรุปผลการวิเคราะห์ (Summary & Insights)
                </h3>
                <div id="summaryContent" class="space-y-3 text-slate-600 text-sm leading-relaxed">
                    <!-- Dynamic Content will appear here -->
                    <p class="animate-pulse">กำลังประมวลผลข้อมูล...</p>
                </div>
            </div>

            <!-- Key Findings -->
            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-emerald-500">
                <h3 class="font-bold text-lg text-slate-800 mb-3">
                    <i class="ph ph-lightbulb text-emerald-600 mr-1"></i> ข้อค้นพบหลัก (Key Findings)
                </h3>
                <ul id="findingsContent" class="list-disc list-outside ml-4 space-y-2 text-slate-600 text-sm">
                    <!-- Dynamic Content will appear here -->
                    <li class="animate-pulse">กำลังวิเคราะห์ข้อมูล...</li>
                </ul>
            </div>
        </section>

        <!-- Footer Actions -->
        <footer class="flex flex-col md:flex-row justify-end items-center gap-4 py-8 no-print border-t border-slate-200 mt-8">
            <button onclick="window.print()" class="flex items-center gap-2 px-6 py-3 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 font-medium transition-all shadow-sm">
                <i class="ph ph-printer text-lg"></i>
                Print Report
            </button>
            <button onclick="exportToCSV()" class="flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 font-medium transition-all shadow-lg hover:shadow-indigo-200">
                <i class="ph ph-download-simple text-lg"></i>
                Export CSV
            </button>
        </footer>

    </div>

    <script>
        // 1. Mock Data (10 Rows as requested)
        const mockData = `Transaction_ID,Date,Customer_ID,Product_Category,Sales_Amount,Region
TXN-01997,14/04/2024,C-0049,Sports,24903.5,Bangkok
TXN-01998,17/11/2024,C-0019,Sports,42341.0,Bangkok
TXN-01999,01/08/2024,C-0368,Electronics,29987.0,Bangkok
TXN-02000,04/10/2024,C-0903,Electronics,49601.0,Chonburi
TXN-02001,15/05/2024,C-0055,Fashion,12500.0,Phuket
TXN-02002,22/12/2024,C-0112,Home & Living,8750.0,Chiang Mai
TXN-02003,10/01/2024,C-0233,Beauty,3450.0,Bangkok
TXN-02004,28/06/2024,C-0441,Electronics,55200.0,Phuket
TXN-02005,14/09/2024,C-0889,Sports,18900.0,Khon Kaen
TXN-02006,03/03/2024,C-0777,Fashion,22100.0,Chonburi`;

        let globalChartInstances = {};
        let currentData = [];

        // Set Current Date
        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('th-TH', {
            year: 'numeric', month: 'long', day: 'numeric'
        });

        // 2. CSV Parser
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(','); // Simple split, assumes no commas in fields for this workshop
                const entry = {};
                headers.forEach((header, index) => {
                    let val = values[index] ? values[index].trim() : '';
                    
                    // Convert Sales_Amount to Number
                    if (header === 'Sales_Amount') val = parseFloat(val) || 0;
                    
                    entry[header] = val;
                });
                return entry;
            });
        }

        // 3. Process Data for Charts
        function processDataForCharts(data) {
            
            // A. Monthly Sales (Line Chart)
            const monthlySales = Array(12).fill(0);
            data.forEach(row => {
                const [day, month, year] = row.Date.split('/');
                const monthIndex = parseInt(month) - 1; // 0-11
                if (monthIndex >= 0 && monthIndex < 12) {
                    monthlySales[monthIndex] += row.Sales_Amount;
                }
            });

            // B. Region Sales (Pie Chart)
            const regionSales = {};
            data.forEach(row => {
                const region = row.Region || 'Unknown';
                regionSales[region] = (regionSales[region] || 0) + row.Sales_Amount;
            });

            // C. Top 5 Products (Bar Chart)
            const productSales = {};
            data.forEach(row => {
                const product = row.Product_Category || 'Unknown';
                productSales[product] = (productSales[product] || 0) + row.Sales_Amount;
            });
            const sortedProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            // D. Histogram (Distribution)
            const salesAmounts = data.map(d => d.Sales_Amount);
            const maxSale = Math.max(...salesAmounts);
            const minSale = Math.min(...salesAmounts);
            const binCount = 5; // Fixed 5 bins for simplicity
            const binSize = (maxSale - minSale) / binCount;
            
            const histogramBins = Array(binCount).fill(0);
            const binLabels = [];

            for (let i = 0; i < binCount; i++) {
                const start = Math.floor(minSale + (i * binSize));
                const end = Math.floor(minSale + ((i + 1) * binSize));
                binLabels.push(`${start.toLocaleString()} - ${end.toLocaleString()}`);
            }

            salesAmounts.forEach(amount => {
                let binIndex = Math.floor((amount - minSale) / binSize);
                if (binIndex >= binCount) binIndex = binCount - 1;
                histogramBins[binIndex]++;
            });

            return { monthlySales, regionSales, sortedProducts, histogramBins, binLabels };
        }

        // 4. Generate Analysis Text
        function generateInsights(processed, rawData) {
            const totalSales = rawData.reduce((sum, item) => sum + item.Sales_Amount, 0);
            const formattedTotal = totalSales.toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
            
            // Find Best Month
            const months = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            const maxMonthVal = Math.max(...processed.monthlySales);
            const maxMonthIdx = processed.monthlySales.indexOf(maxMonthVal);
            const bestMonth = months[maxMonthIdx];

            // Find Top Region
            const regions = Object.entries(processed.regionSales);
            regions.sort((a, b) => b[1] - a[1]);
            const topRegion = regions[0];

            // Summary HTML
            document.getElementById('summaryContent').innerHTML = `
                <p>จากการวิเคราะห์ข้อมูลธุรกรรมจำนวน <strong>${rawData.length.toLocaleString()} รายการ</strong> พบว่ามียอดขายรวมทั้งสิ้น <span class="text-indigo-600 font-bold">${formattedTotal}</span> โดยเดือนที่มียอดขายสูงสุดคือเดือน<strong>${bestMonth}</strong> และพื้นที่ที่ทำยอดขายได้มากที่สุดคือ <strong>${topRegion[0]}</strong> (${topRegion[1].toLocaleString()} บาท)</p>
                <p class="mt-2">สินค้าหมวด <strong>${processed.sortedProducts[0][0]}</strong> เป็นสินค้าที่สร้างรายได้หลักให้กับบริษัทในปีนี้</p>
            `;

            // Key Findings HTML
            document.getElementById('findingsContent').innerHTML = `
                <li><strong>Top Performer:</strong> ภูมิภาค ${topRegion[0]} ครองส่วนแบ่งการตลาดสูงสุด</li>
                <li><strong>Best Seller:</strong> สินค้ากลุ่ม ${processed.sortedProducts[0][0]} มียอดขายอันดับ 1</li>
                <li><strong>Sales Trend:</strong> ช่วงปลายปี (Q4) มีแนวโน้มยอดขายที่โดดเด่น</li>
                <li><strong>Transaction Value:</strong> ยอดซื้อส่วนใหญ่อยู่ในช่วง ${processed.binLabels[processed.histogramBins.indexOf(Math.max(...processed.histogramBins))]} บาท</li>
            `;
        }

        // 5. Render Charts
        function renderCharts(data) {
            const { monthlySales, regionSales, sortedProducts, histogramBins, binLabels } = processDataForCharts(data);
            generateInsights({ monthlySales, regionSales, sortedProducts, histogramBins, binLabels }, data);

            // Destroy old charts if exist
            Object.values(globalChartInstances).forEach(chart => chart.destroy());

            // 1. Monthly Line Chart
            const ctx1 = document.getElementById('monthlyChart').getContext('2d');
            globalChartInstances.monthly = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'],
                    datasets: [{
                        label: 'ยอดขายรายเดือน (บาท)',
                        data: monthlySales,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 2. Region Pie Chart
            const ctx2 = document.getElementById('regionChart').getContext('2d');
            globalChartInstances.region = new Chart(ctx2, {
                type: 'pie',
                data: {
                    labels: Object.keys(regionSales),
                    datasets: [{
                        data: Object.values(regionSales),
                        backgroundColor: ['#6366f1', '#f43f5e', '#f59e0b', '#10b981', '#8b5cf6', '#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                }
            });

            // 3. Top Products Bar Chart
            const ctx3 = document.getElementById('productChart').getContext('2d');
            globalChartInstances.product = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: sortedProducts.map(p => p[0]),
                    datasets: [{
                        label: 'ยอดขาย (บาท)',
                        data: sortedProducts.map(p => p[1]),
                        backgroundColor: '#f59e0b',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 4. Histogram
            const ctx4 = document.getElementById('histogramChart').getContext('2d');
            globalChartInstances.histogram = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'จำนวนบิล (Frequency)',
                        data: histogramBins,
                        backgroundColor: '#a855f7',
                        barPercentage: 0.95,
                        categoryPercentage: 0.95
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, title: { display: true, text: 'จำนวนรายการ' } } }
                }
            });
        }

        // 6. Event Listeners
        function init() {
            // Load Mock Data initially
            currentData = parseCSV(mockData);
            renderCharts(currentData);
        }

        // Upload Handler
        document.getElementById('csvInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                currentData = parseCSV(text);
                renderCharts(currentData);
                // alert('นำเข้าข้อมูลสำเร็จ: ' + currentData.length + ' แถว');
            };
            reader.readAsText(file);
        });

        // Reset Data
        window.resetData = function() {
            document.getElementById('csvInput').value = '';
            currentData = parseCSV(mockData);
            renderCharts(currentData);
        };

        // Export CSV Function
        window.exportToCSV = function() {
            if (!currentData || currentData.length === 0) return;

            // Get headers
            const headers = Object.keys(currentData[0]);
            
            // Create CSV content
            const csvContent = [
                headers.join(','),
                ...currentData.map(row => headers.map(fieldName => {
                    // Handle potential commas in data by quoting
                    let val = row[fieldName];
                    if (typeof val === 'string' && val.includes(',')) val = `"${val}"`;
                    return val;
                }).join(','))
            ].join('\n');

            // Create download link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'executive_sales_report_2024.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Initialize
        init();

    </script>
</body>
</html>
