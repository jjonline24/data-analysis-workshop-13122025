<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop 12: Sales Outlier Analysis (IQR)</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .shadow-sm, .shadow-lg { box-shadow: none !important; }
            .bg-slate-100 { background-color: white !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen p-6">

    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-600">
            <div>
                <h1 class="text-2xl font-bold text-indigo-800">üìä Workshop 12: Sales Outlier Analysis</h1>
                <p class="text-slate-500 text-sm mt-1">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Outliers) ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ IQR (Interquartile Range)</p>
            </div>
            <div class="mt-4 md:mt-0 text-right">
                <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider">METHODOLOGY</div>
                <div class="text-indigo-600 font-bold">Interquartile Range (IQR)</div>
            </div>
        </header>

        <!-- Requirements Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Col 1: To Do -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="p-2 bg-blue-100 text-blue-600 rounded-lg">
                        <i class="fas fa-list-check"></i>
                    </div>
                    <h2 class="font-bold text-slate-700">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (To Do)</h2>
                </div>
                <ul class="space-y-3 text-sm text-slate-600">
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                        <span>‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Transaction ‡πÅ‡∏•‡∏∞ Sales Amount</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                        <span>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏´‡∏≤‡∏Ñ‡πà‡∏≤ Q1, Q3 ‡πÅ‡∏•‡∏∞ IQR</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check-circle text-green-500 mt-1 mr-2"></i>
                        <span>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï (Lower & Upper Bounds)</span>
                    </li>
                </ul>
            </div>

            <!-- Col 2: Analysis -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="p-2 bg-purple-100 text-purple-600 rounded-lg">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h2 class="font-bold text-slate-700">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Analysis)</h2>
                </div>
                <ul class="space-y-3 text-sm text-slate-600">
                    <li class="flex items-start">
                        <i class="fas fa-search text-purple-500 mt-1 mr-2"></i>
                        <span>‡∏£‡∏∞‡∏ö‡∏∏ Transaction ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô Outlier</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-calculator text-purple-500 mt-1 mr-2"></i>
                        <span>Rule: Sales < Q1 - 1.5*IQR ‡∏´‡∏£‡∏∑‡∏≠ Sales > Q3 + 1.5*IQR</span>
                    </li>
                </ul>
            </div>

            <!-- Col 3: Deliverables -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg">
                        <i class="fas fa-file-export"></i>
                    </div>
                    <h2 class="font-bold text-slate-700">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Deliverables)</h2>
                </div>
                <ul class="space-y-3 text-sm text-slate-600">
                    <li class="flex items-start">
                        <i class="fas fa-chart-bar text-emerald-500 mt-1 mr-2"></i>
                        <span>‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û Boxplot ‡πÑ‡∏Æ‡πÑ‡∏•‡∏ó‡πå‡∏à‡∏∏‡∏î Outlier</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-table text-emerald-500 mt-1 mr-2"></i>
                        <span>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Outlier Transactions</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-lightbulb text-emerald-500 mt-1 mr-2"></i>
                        <span>‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏• Key Findings</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="bg-white p-6 rounded-xl shadow-sm no-print">
            <h2 class="text-lg font-bold text-slate-700 mb-4 flex items-center">
                <i class="fas fa-database mr-2 text-indigo-500"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Data Source)
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Method 2: Upload CSV -->
                <div class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:border-indigo-400 transition-colors bg-slate-50">
                    <div class="mb-3">
                        <i class="fas fa-cloud-upload-alt text-3xl text-slate-400"></i>
                    </div>
                    <h3 class="font-semibold text-slate-700">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV</h3>
                    <p class="text-xs text-slate-500 mb-4">‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Sales_Amount</p>
                    <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                    <button onclick="document.getElementById('csvInput').click()" 
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors text-sm font-medium">
                        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
                    </button>
                    <p id="fileNameDisplay" class="text-xs text-slate-500 mt-2 h-4"></p>
                </div>

                <!-- Info Box -->
                <div class="bg-blue-50 rounded-xl p-6 border border-blue-100">
                    <h3 class="font-semibold text-blue-800 mb-2">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h3>
                    <p class="text-sm text-blue-600 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Mock Data 10 ‡πÅ‡∏ñ‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Layout</p>
                    <div class="text-xs text-blue-500 font-mono bg-white p-2 rounded border border-blue-100">
                        Format: TXN-ID, Date, Customer_ID, Category, Sales, Region
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary & Key Findings -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Stats Cards -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-blue-500">
                    <p class="text-xs text-slate-500 uppercase">Total Transactions</p>
                    <h3 class="text-2xl font-bold text-slate-800" id="totalCount">-</h3>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-red-500">
                    <p class="text-xs text-slate-500 uppercase">Outliers Found</p>
                    <div class="flex items-end space-x-2">
                        <h3 class="text-2xl font-bold text-red-600" id="outlierCount">-</h3>
                        <span class="text-sm text-slate-400 mb-1" id="outlierPercent">(-%)</span>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border-l-4 border-emerald-500">
                    <p class="text-xs text-slate-500 uppercase">IQR Thresholds</p>
                    <div class="space-y-1 mt-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-500">Lower Bound:</span>
                            <span class="font-mono font-bold text-slate-700" id="lowerBoundVal">-</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-500">Upper Bound:</span>
                            <span class="font-mono font-bold text-slate-700" id="upperBoundVal">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Findings Text -->
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm">
                <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">
                    <i class="fas fa-search-plus text-indigo-500 mr-2"></i> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏´‡∏•‡∏±‡∏Å (Key Findings)
                </h3>
                <div id="keyFindings" class="text-slate-600 space-y-3 text-sm leading-relaxed">
                    <p class="text-slate-400 italic">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>
        </div>

        <!-- Visualization -->
        <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-slate-700 mb-6 flex justify-between items-center">
                <span><i class="fas fa-chart-scatter text-indigo-500 mr-2"></i> ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Outlier Visualization)</span>
                <span class="text-xs font-normal bg-slate-100 px-3 py-1 rounded-full text-slate-500">Unit: THB</span>
            </h3>
            <div class="h-96 w-full">
                <canvas id="outlierChart"></canvas>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-red-50">
                <h3 class="font-bold text-red-700">
                    <i class="fas fa-exclamation-triangle mr-2"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Outlier
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-slate-600">
                    <thead class="bg-slate-50 text-slate-700 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-6 py-3">Transaction ID</th>
                            <th class="px-6 py-3">Date</th>
                            <th class="px-6 py-3">Customer ID</th>
                            <th class="px-6 py-3">Category</th>
                            <th class="px-6 py-3 text-right">Sales Amount</th>
                            <th class="px-6 py-3">Status</th>
                        </tr>
                    </thead>
                    <tbody id="outlierTableBody" class="divide-y divide-slate-100">
                        <!-- Rows generated via JS -->
                    </tbody>
                </table>
            </div>
            <div class="p-4 bg-slate-50 text-center text-xs text-slate-400" id="tableFooter">
                Showing outliers only
            </div>
        </div>

        <!-- Actions Footer -->
        <div class="flex justify-between items-center pt-6 pb-12 no-print">
            <button onclick="window.print()" class="flex items-center space-x-2 text-slate-500 hover:text-slate-700 transition-colors px-4 py-2 rounded-lg hover:bg-slate-200">
                <i class="fas fa-print"></i>
                <span>Print Report</span>
            </button>
            <button onclick="exportOutliersCSV()" class="bg-emerald-600 text-white px-6 py-3 rounded-xl hover:bg-emerald-700 transition-shadow shadow-lg shadow-emerald-200 flex items-center space-x-2 font-medium">
                <i class="fas fa-file-csv"></i>
                <span>Export Outliers CSV</span>
            </button>
        </div>

    </div>

    <script>
        // --- 1. MOCK DATA (10 Rows for Layout Testing) ---
        const mockCSV = `Transaction_ID,Date,Customer_ID,Product_Category,Sales_Amount,Region
TXN-01997,14/04/2024,C-0049,Sports,24903.5,Bangkok
TXN-01998,17/11/2024,C-0019,Sports,42341.0,Bangkok
TXN-01999,01/08/2024,C-0368,Electronics,29987.0,Bangkok
TXN-02000,04/10/2024,C-0903,Electronics,49601.0,Chonburi
TXN-02001,15/01/2024,C-0112,Fashion,1200.0,Phuket
TXN-02002,20/03/2024,C-0223,Beauty,85000.0,Chiang Mai
TXN-02003,05/06/2024,C-0334,Home,500.0,Khon Kaen
TXN-02004,12/09/2024,C-0445,Electronics,31000.0,Bangkok
TXN-02005,25/12/2024,C-0556,Sports,110000.0,Phuket
TXN-02006,01/02/2024,C-0667,Fashion,2800.0,Chonburi`;

        let currentOutliers = []; // Store for export
        let chartInstance = null;

        // --- 2. LOGIC: PARSE CSV ---
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            // Map columns
            const idxID = headers.findIndex(h => h.includes('Transaction') || h.includes('TXN'));
            const idxDate = headers.findIndex(h => h.includes('Date'));
            const idxCust = headers.findIndex(h => h.includes('Customer'));
            const idxCat = headers.findIndex(h => h.includes('Category'));
            const idxSales = headers.findIndex(h => h.includes('Sales') || h.includes('Amount'));

            if (idxSales === -1) {
                alert("Error: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Sales_Amount ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV");
                return [];
            }

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(',').map(c => c.trim());
                if (cols.length < headers.length) continue;

                const sales = parseFloat(cols[idxSales]);
                if (!isNaN(sales)) {
                    data.push({
                        id: cols[idxID] || `Row-${i}`,
                        date: cols[idxDate] || '-',
                        cust: cols[idxCust] || '-',
                        cat: cols[idxCat] || '-',
                        sales: sales
                    });
                }
            }
            return data;
        }

        // --- 3. LOGIC: IQR CALCULATION ---
        function calculateOutliers(data) {
            // Sort by sales
            const sorted = [...data].sort((a, b) => a.sales - b.sales);
            const values = sorted.map(d => d.sales);
            
            // Helper for quartiles
            const q1 = d3_quantile(values, 0.25);
            const q3 = d3_quantile(values, 0.75);
            const iqr = q3 - q1;
            
            const lowerBound = q1 - (1.5 * iqr);
            const upperBound = q3 + (1.5 * iqr);

            // Mark outliers
            const analyzedData = data.map(d => {
                const isLow = d.sales < lowerBound;
                const isHigh = d.sales > upperBound;
                return {
                    ...d,
                    isOutlier: isLow || isHigh,
                    outlierType: isLow ? 'Low' : (isHigh ? 'High' : 'Normal')
                };
            });

            return {
                data: analyzedData,
                stats: { q1, q3, iqr, lowerBound, upperBound }
            };
        }

        // Simple Quartile Implementation (Linear interpolation)
        function d3_quantile(sortedArr, q) {
            const pos = (sortedArr.length - 1) * q;
            const base = Math.floor(pos);
            const rest = pos - base;
            if (sortedArr[base + 1] !== undefined) {
                return sortedArr[base] + rest * (sortedArr[base + 1] - sortedArr[base]);
            } else {
                return sortedArr[base];
            }
        }

        // --- 4. RENDER UI ---
        function processData(csvString, sourceName) {
            const rawData = parseCSV(csvString);
            const result = calculateOutliers(rawData);
            
            currentOutliers = result.data.filter(d => d.isOutlier);

            updateStats(result.data, result.stats);
            renderChart(result.data, result.stats);
            renderTable(currentOutliers);
            generateKeyFindings(result.data.length, currentOutliers, result.stats);
        }

        function updateStats(allData, stats) {
            document.getElementById('totalCount').innerText = allData.length.toLocaleString();
            
            const outlierCount = allData.filter(d => d.isOutlier).length;
            document.getElementById('outlierCount').innerText = outlierCount.toLocaleString();
            
            const pct = ((outlierCount / allData.length) * 100).toFixed(1);
            document.getElementById('outlierPercent').innerText = `(${pct}%)`;

            document.getElementById('lowerBoundVal').innerText = stats.lowerBound.toLocaleString(undefined, {maximumFractionDigits: 0});
            document.getElementById('upperBoundVal').innerText = stats.upperBound.toLocaleString(undefined, {maximumFractionDigits: 0});
        }

        function generateKeyFindings(total, outliers, stats) {
            const container = document.getElementById('keyFindings');
            const highOutliers = outliers.filter(o => o.outlierType === 'High');
            const lowOutliers = outliers.filter(o => o.outlierType === 'Low');
            
            let html = `
                <p>‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <strong>${total.toLocaleString()} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong> ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ IQR ‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:</p>
                <ul class="list-disc pl-5 mt-2 space-y-1">
                    <li>
                        ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ (Outliers) ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <strong>${outliers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</strong> 
                        ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô <strong>${((outliers.length/total)*100).toFixed(2)}%</strong> ‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </li>
                    <li>
                        <strong>‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏õ‡∏Å‡∏ï‡∏¥ (Normal Range):</strong> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á 
                        ${stats.lowerBound.toLocaleString()} ‡∏ñ‡∏∂‡∏á ${stats.upperBound.toLocaleString()} ‡∏ö‡∏≤‡∏ó
                    </li>
            `;

            if (highOutliers.length > 0) {
                const maxVal = Math.max(...highOutliers.map(o => o.sales));
                html += `<li><span class="text-red-600 font-semibold">High Outliers:</span> ‡∏û‡∏ö ${highOutliers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏π‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÇ‡∏î‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà ${maxVal.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ Project ‡πÉ‡∏´‡∏ç‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</li>`;
            }

            if (lowOutliers.length > 0) {
                 html += `<li><span class="text-amber-600 font-semibold">Low Outliers:</span> ‡∏û‡∏ö ${lowOutliers.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡πà‡∏≥‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥</li>`;
            }

            html += `</ul>`;
            container.innerHTML = html;
        }

        function renderTable(outliers) {
            const tbody = document.getElementById('outlierTableBody');
            tbody.innerHTML = '';
            
            if (outliers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Outlier</td></tr>`;
                return;
            }

            outliers.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors";
                tr.innerHTML = `
                    <td class="px-6 py-3 font-mono text-xs text-slate-500">${row.id}</td>
                    <td class="px-6 py-3">${row.date}</td>
                    <td class="px-6 py-3 font-mono text-xs">${row.cust}</td>
                    <td class="px-6 py-3"><span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md text-xs font-semibold">${row.cat}</span></td>
                    <td class="px-6 py-3 text-right font-bold text-slate-700">${row.sales.toLocaleString()}</td>
                    <td class="px-6 py-3">
                        <span class="${row.outlierType === 'High' ? 'bg-red-100 text-red-700' : 'bg-amber-100 text-amber-700'} px-2 py-1 rounded-full text-xs font-bold">
                            ${row.outlierType} Outlier
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 5. CHART JS: SCATTER PLOT WITH LINES ---
        function renderChart(data, stats) {
            const ctx = document.getElementById('outlierChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            // Prepare Data Points (Jitter X to reduce overlap)
            const normalPoints = data.filter(d => !d.isOutlier).map(d => ({ x: Math.random() * 0.8 + 0.1, y: d.sales }));
            const outlierPoints = data.filter(d => d.isOutlier).map(d => ({ x: Math.random() * 0.8 + 0.1, y: d.sales, raw: d }));

            chartInstance = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Outliers',
                            data: outlierPoints,
                            backgroundColor: '#ef4444', // Red-500
                            borderColor: '#b91c1c',
                            borderWidth: 1,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Normal Data',
                            data: normalPoints,
                            backgroundColor: '#94a3b8', // Slate-400
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const raw = context.raw.raw;
                                    if(raw) {
                                        return `${raw.id}: ${raw.sales.toLocaleString()} (${raw.cat})`;
                                    }
                                    return `Sales: ${context.raw.y.toLocaleString()}`;
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: stats.upperBound,
                                    yMax: stats.upperBound,
                                    borderColor: '#f59e0b', // Amber
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `Upper Bound: ${stats.upperBound.toLocaleString()}`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: '#f59e0b',
                                        color: 'white'
                                    }
                                },
                                line2: {
                                    type: 'line',
                                    yMin: stats.lowerBound,
                                    yMax: stats.lowerBound,
                                    borderColor: '#f59e0b',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `Lower Bound: ${stats.lowerBound.toLocaleString()}`,
                                        display: true,
                                        position: 'end',
                                        backgroundColor: '#f59e0b',
                                        color: 'white'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: false, // Hide X axis (simulated categorical)
                            min: 0,
                            max: 1
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Sales Amount (THB)',
                                font: { family: "'Sarabun', sans-serif" }
                            },
                            ticks: {
                                callback: function(value) { return value.toLocaleString(); }
                            }
                        }
                    }
                },
                plugins: [{
                    // Custom plugin to draw lines manually if annotation plugin fails or simplifies dependency
                    id: 'customLines',
                    beforeDraw: (chart) => {
                        const { ctx, scales: { y, x } } = chart;
                        const w = chart.width;
                        
                        // Draw Upper Bound
                        const yHigh = y.getPixelForValue(stats.upperBound);
                        if (yHigh > 0 && yHigh < chart.height) {
                            ctx.save();
                            ctx.beginPath();
                            ctx.strokeStyle = '#f59e0b'; // Amber-500
                            ctx.setLineDash([5, 5]);
                            ctx.lineWidth = 2;
                            ctx.moveTo(x.left, yHigh);
                            ctx.lineTo(x.right, yHigh);
                            ctx.stroke();
                            ctx.restore();
                        }

                         // Draw Lower Bound
                        const yLow = y.getPixelForValue(stats.lowerBound);
                        if (yLow > 0 && yLow < chart.height) {
                            ctx.save();
                            ctx.beginPath();
                            ctx.strokeStyle = '#f59e0b'; 
                            ctx.setLineDash([5, 5]);
                            ctx.lineWidth = 2;
                            ctx.moveTo(x.left, yLow);
                            ctx.lineTo(x.right, yLow);
                            ctx.stroke();
                            ctx.restore();
                        }
                    }
                }]
            });
        }

        // --- 6. FILE HANDLING ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('fileNameDisplay').innerText = `Selected: ${file.name}`;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                processData(e.target.result, file.name);
            };
            reader.readAsText(file);
        }

        function exportOutliersCSV() {
            if (currentOutliers.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Outlier ‡πÉ‡∏´‡πâ Export");
                return;
            }

            // Create CSV Content
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Transaction_ID,Date,Customer_ID,Product_Category,Sales_Amount,Region,Outlier_Type\n";
            
            currentOutliers.forEach(row => {
                csvContent += `${row.id},${row.date},${row.cust},${row.cat},${row.sales},${row.region || '-'},${row.outlierType}\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "sales_outliers_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize with Mock Data
        window.addEventListener('DOMContentLoaded', () => {
            processData(mockCSV, 'Mock Data (10 Rows)');
        });

    </script>
</body>
</html>
