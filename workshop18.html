<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop 18: Sales Analytics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kanit:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Kanit', sans-serif;
            background-color: #0f172a;
            color: #f1f5f9;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }
        .header-gradient {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .info-column {
            border-left: 4px solid #3b82f6;
        }
        @media print {
            .no-print { display: none; }
            body { background-color: white; color: black; }
            .glass-card { border: 1px solid #ccc; background: white; backdrop-filter: none; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <!-- Header Section -->
    <header class="max-w-7xl mx-auto mb-10">
        <h1 class="text-4xl font-bold header-gradient mb-2">Workshop 18: Sales Analytics Dashboard</h1>
        <p class="text-slate-400">ระบบวิเคราะห์ข้อมูลการขายอัจฉริยะ รองรับการประมวลผล CSV หลายไฟล์พร้อมกัน</p>
    </header>

    <!-- Project Goals & Layout Section (Workshop 3 Style) -->
    <div class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
        <div class="glass-card p-6 info-column">
            <h3 class="text-blue-400 font-semibold mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="List-bullet" /></svg>
                สิ่งที่ต้องทำ (Tasks)
            </h3>
            <ul class="text-sm text-slate-300 space-y-2">
                <li>• พัฒนา Dashboard ด้วย HTML/JS ไฟล์เดียว</li>
                <li>• รวมข้อมูลจากไฟล์ CSV หลายแหล่ง</li>
                <li>• คำนวณยอดขายรวมและจำนวนธุรกรรม</li>
                <li>• สร้าง Visualization จำแนกตามหมวดหมู่และภูมิภาค</li>
            </ul>
        </div>
        <div class="glass-card p-6 border-l-4 border-purple-500">
            <h3 class="text-purple-400 font-semibold mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                การวิเคราะห์ (Analysis)
            </h3>
            <p class="text-sm text-slate-300">ใช้ PapaParse ในการรวบรวม Data Stream และประมวลผลข้อมูลเชิงสถิติ (Categorical & Regional Analysis) เพื่อหาข้อค้นพบสำคัญจากการขาย</p>
        </div>
        <div class="glass-card p-6 border-l-4 border-emerald-500">
            <h3 class="text-emerald-400 font-semibold mb-3 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                ผลลัพธ์ (Deliverables)
            </h3>
            <p class="text-sm text-slate-300">รายงานรูปแบบ Interactive Dashboard พร้อมระบบสรุปใจความสำคัญอัตโนมัติ และฟังก์ชันการส่งออกรายงานเป็นไฟล์ CSV และ PDF</p>
        </div>
    </div>

    <!-- Data Import Section (Method 2 style from Workshop 3) -->
    <section class="max-w-7xl mx-auto mb-10 no-print">
        <div class="glass-card p-8 text-center border-dashed border-2 border-slate-700">
            <h2 class="text-xl font-medium mb-4">อัปโหลดไฟล์ข้อมูล CSV (Multiple Files)</h2>
            <div class="flex flex-col items-center">
                <input type="file" id="csvFileInput" multiple accept=".csv" class="hidden">
                <label for="csvFileInput" class="btn-primary px-8 py-3 rounded-full cursor-pointer font-medium inline-flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                    คลิกเพื่อเลือกไฟล์ CSV
                </label>
            </div>
        </div>
    </section>

    <!-- Main Dashboard -->
    <main class="max-w-7xl mx-auto space-y-8">
        
        <!-- Scorecards -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-6 flex items-center space-x-4">
                <div class="p-4 bg-blue-500/20 rounded-2xl text-blue-400">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <div>
                    <p class="text-slate-400 text-sm">ยอดขายรวม (Total Sales)</p>
                    <h2 id="totalSales" class="text-3xl font-bold text-white">฿0.00</h2>
                </div>
            </div>
            <div class="glass-card p-6 flex items-center space-x-4">
                <div class="p-4 bg-purple-500/20 rounded-2xl text-purple-400">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" /></svg>
                </div>
                <div>
                    <p class="text-slate-400 text-sm">จำนวนรายการ (Transactions)</p>
                    <h2 id="txnCount" class="text-3xl font-bold text-white">0</h2>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass-card p-6">
                <h3 class="text-lg font-medium mb-6 flex items-center">
                    <span class="w-2 h-6 bg-blue-500 rounded-full mr-3"></span>
                    ยอดขายตามหมวดหมู่ (Category Sales)
                </h3>
                <div class="h-64">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            <div class="glass-card p-6">
                <h3 class="text-lg font-medium mb-6 flex items-center">
                    <span class="w-2 h-6 bg-purple-500 rounded-full mr-3"></span>
                    สัดส่วนตามภูมิภาค (Region Share)
                </h3>
                <div class="h-64">
                    <canvas id="regionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Summary & Insights Section -->
        <div class="glass-card p-8">
            <h3 class="text-xl font-semibold mb-6 flex items-center border-b border-slate-700 pb-4">
                <svg class="w-6 h-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                สรุปผลการวิเคราะห์ (Summary & Insights)
            </h3>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-slate-400 uppercase text-xs font-bold tracking-widest mb-4">ข้อค้นพบหลัก (Key Findings)</h4>
                    <div id="keyFindings" class="space-y-4 text-slate-200">
                        <!-- Dynamic Findings -->
                        <p class="text-sm italic text-slate-500">รอการประมวลผลข้อมูล...</p>
                    </div>
                </div>
                <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                    <h4 class="text-slate-400 uppercase text-xs font-bold tracking-widest mb-4">Auto-Summary</h4>
                    <div id="autoSummary" class="text-slate-300 leading-relaxed">
                        ระบบจะวิเคราะห์สินค้าขายดีและแนวโน้มเมื่ออัปโหลดข้อมูลสำเร็จ
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Buttons -->
        <div class="flex flex-wrap justify-center gap-4 py-10 no-print">
            <button id="exportCsvBtn" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-xl font-medium flex items-center transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                Export CSV
            </button>
            <button onclick="window.print()" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-medium flex items-center transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" /></svg>
                Print Report
            </button>
        </div>
    </main>

    <script>
        // --- Mock Data (10 Rows for Layout Preview) ---
        const initialMockData = `TXN-01991,10/04/2024,C-0001,Electronics,15000.0,Bangkok
TXN-01992,11/04/2024,C-0002,Sports,5000.0,Chonburi
TXN-01993,12/04/2024,C-0003,Home,8500.0,Phuket
TXN-01994,12/04/2024,C-0004,Electronics,21000.0,Bangkok
TXN-01995,13/04/2024,C-0005,Fashion,3200.0,Chiang Mai
TXN-01996,14/04/2024,C-0006,Electronics,45000.0,Bangkok
TXN-01997,14/04/2024,C-0049,Sports,24903.5,Bangkok
TXN-01998,17/11/2024,C-0019,Sports,42341.0,Bangkok
TXN-01999,01/08/2024,C-0368,Electronics,29987.0,Bangkok
TXN-02000,04/10/2024,C-0903,Electronics,49601.0,Chonburi`;

        let allData = [];
        let categoryChart, regionChart;

        window.onload = () => {
            // Initial render with mock data
            const parsedMock = Papa.parse(initialMockData, { header: false }).data.map(row => ({
                txnId: row[0],
                date: row[1],
                custId: row[2],
                category: row[3],
                sales: parseFloat(row[4]),
                region: row[5]
            }));
            processData(parsedMock);
        };

        // File Selection Logic
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const files = e.target.files;
            if (files.length === 0) return;

            let loadedFiles = 0;
            let mergedRows = [];
            
            document.getElementById('fileStatus').innerText = `กำลังอ่านไฟล์ ${files.length} รายการ...`;

            Array.from(files).forEach(file => {
                Papa.parse(file, {
                    header: false,
                    skipEmptyLines: true,
                    complete: function(results) {
                        const rows = results.data.map(row => ({
                            txnId: row[0],
                            date: row[1],
                            custId: row[2],
                            category: row[3],
                            sales: parseFloat(row[4]) || 0,
                            region: row[5]
                        }));
                        mergedRows = mergedRows.concat(rows);
                        loadedFiles++;

                        if (loadedFiles === files.length) {
                            processData(mergedRows);
                            document.getElementById('fileStatus').innerText = `อัปโหลดสำเร็จ! ประมวลผล ${mergedRows.length} รายการ`;
                        }
                    }
                });
            });
        });

        // Core Data Processing
        function processData(data) {
            allData = data;
            
            // Calculate Stats
            const totalSales = data.reduce((sum, row) => sum + row.sales, 0);
            const txnTotal = data.length;

            document.getElementById('totalSales').innerText = `฿${totalSales.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('txnCount').innerText = txnTotal.toLocaleString();

            // Aggregate Charts
            const catMap = {};
            const regionMap = {};

            data.forEach(row => {
                catMap[row.category] = (catMap[row.category] || 0) + row.sales;
                regionMap[row.region] = (regionMap[row.region] || 0) + 1;
            });

            updateCharts(catMap, regionMap);
            generateInsights(data, catMap, regionMap, totalSales);
        }

        // Visualization
        function updateCharts(catData, regionData) {
            if (categoryChart) categoryChart.destroy();
            if (regionChart) regionChart.destroy();

            const ctx1 = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(catData),
                    datasets: [{
                        label: 'ยอดขายรายหมวดหมู่',
                        data: Object.values(catData),
                        backgroundColor: '#3b82f6',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            const ctx2 = document.getElementById('regionChart').getContext('2d');
            regionChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(regionData),
                    datasets: [{
                        data: Object.values(regionData),
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 20 } }
                    },
                    cutout: '70%'
                }
            });
        }

        // Logic for Insights & Auto-Summary
        function generateInsights(data, catMap, regionMap, total) {
            const topCategory = Object.keys(catMap).reduce((a, b) => catMap[a] > catMap[b] ? a : b);
            const topRegion = Object.keys(regionMap).reduce((a, b) => regionMap[a] > regionMap[b] ? a : b);
            const avgSales = total / data.length;

            // Update Key Findings
            const findingsHtml = `
                <div class="flex items-start">
                    <span class="bg-blue-500 w-2 h-2 rounded-full mt-1.5 mr-3 flex-shrink-0"></span>
                    <p>กลุ่มสินค้า <strong class="text-blue-400">${topCategory}</strong> ครองสัดส่วนรายได้สูงสุด</p>
                </div>
                <div class="flex items-start">
                    <span class="bg-purple-500 w-2 h-2 rounded-full mt-1.5 mr-3 flex-shrink-0"></span>
                    <p>พื้นที่ <strong class="text-purple-400">${topRegion}</strong> มีปริมาณธุรกรรมเกิดขึ้นมากที่สุด</p>
                </div>
                <div class="flex items-start">
                    <span class="bg-emerald-500 w-2 h-2 rounded-full mt-1.5 mr-3 flex-shrink-0"></span>
                    <p>ค่าเฉลี่ยต่อบิลอยู่ที่ <strong class="text-emerald-400">฿${avgSales.toFixed(2)}</strong></p>
                </div>
            `;
            document.getElementById('keyFindings').innerHTML = findingsHtml;

            // Update Auto Summary
            document.getElementById('autoSummary').innerText = `จากการวิเคราะห์ข้อมูลพบว่า ธุรกิจมีความแข็งแกร่งในด้านสินค้ากลุ่ม ${topCategory} ซึ่งเป็นตัวขับเคลื่อนรายได้หลัก โดยเฉพาะในพื้นที่ ${topRegion} ที่มีการขยายตัวสูงสุด แนะนำให้เน้นการทำโปรโมชั่นในหมวดหมู่อื่นๆ เพื่อกระจายความเสี่ยงของรายได้`;
        }

        // Export Functionality
        document.getElementById('exportCsvBtn').addEventListener('click', () => {
            if (allData.length === 0) return alert("ไม่มีข้อมูลสำหรับการส่งออก");
            const csv = Papa.unparse(allData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", "sales_report_export.csv");
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html>
