<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workshop 11: Time Series Decomposition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @media print {
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
            body { background-color: white; }
            .shadow-sm, .shadow-md { box-shadow: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 min-h-screen p-6">

    <div class="max-w-7xl mx-auto space-y-6" id="main-container">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-sm border-l-4 border-indigo-600">
            <div>
                <h1 class="text-2xl font-bold text-indigo-900">üìä Workshop 11: Time Series Decomposition</h1>
                <p class="text-slate-500 text-sm mt-1">‡πÅ‡∏¢‡∏Å‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢: Observed, Trend ‡πÅ‡∏•‡∏∞ Seasonality (‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå)</p>
            </div>
            <div class="mt-4 md:mt-0 flex gap-2">
                 <div class="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg text-sm font-medium">
                    <i class="fas fa-calendar-week mr-2"></i>Weekly View
                </div>
            </div>
        </header>

        <!-- Workshop Objectives & Info -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- To Do -->
            <div class="bg-white p-5 rounded-xl shadow-sm">
                <div class="flex items-center gap-2 mb-3">
                    <div class="p-2 bg-blue-100 text-blue-600 rounded-lg"><i class="fas fa-list-check"></i></div>
                    <h3 class="font-bold text-slate-700">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥ (To Do)</h3>
                </div>
                <ul class="text-sm text-slate-600 space-y-2 list-disc list-inside">
                    <li>Resample ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (Weekly)</li>
                    <li>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Time Series Decomposition</li>
                    <li>‡πÅ‡∏¢‡∏Å Trend (‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°) ‡πÅ‡∏•‡∏∞ Seasonality (‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•)</li>
                </ul>
            </div>

            <!-- Analysis -->
            <div class="bg-white p-5 rounded-xl shadow-sm">
                <div class="flex items-center gap-2 mb-3">
                    <div class="p-2 bg-purple-100 text-purple-600 rounded-lg"><i class="fas fa-chart-line"></i></div>
                    <h3 class="font-bold text-slate-700">‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Analysis)</h3>
                </div>
                <ul class="text-sm text-slate-600 space-y-2 list-disc list-inside">
                    <li>‡πÉ‡∏ä‡πâ Moving Average ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤ Trend</li>
                    <li>‡∏´‡∏≤‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á (Residual/Seasonal) ‡∏à‡∏≤‡∏Å Trend</li>
                    <li>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</li>
                </ul>
            </div>

            <!-- Deliverables -->
            <div class="bg-white p-5 rounded-xl shadow-sm">
                <div class="flex items-center gap-2 mb-3">
                    <div class="p-2 bg-green-100 text-green-600 rounded-lg"><i class="fas fa-file-export"></i></div>
                    <h3 class="font-bold text-slate-700">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå (Deliverables)</h3>
                </div>
                <ul class="text-sm text-slate-600 space-y-2 list-disc list-inside">
                    <li>‡∏Å‡∏£‡∏≤‡∏ü 3 ‡∏ä‡∏±‡πâ‡∏ô (Observed, Trend, Seasonal)</li>
                    <li>‡∏™‡∏£‡∏∏‡∏õ Key Findings</li>
                    <li>‡πÑ‡∏ü‡∏•‡πå CSV ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</li>
                </ul>
            </div>
        </div>

        <!-- Input Section -->
        <div class="bg-white p-6 rounded-xl shadow-sm no-print">
            <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="fas fa-cloud-upload-alt text-indigo-500"></i> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (CSV Upload)
            </h2>
            
            <div class="p-8 border-2 border-dashed border-slate-300 rounded-lg hover:border-indigo-500 transition-colors text-center bg-slate-50 group cursor-pointer" onclick="document.getElementById('csvInput').click()">
                <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleFileUpload(event)">
                <div class="space-y-2">
                    <i class="fas fa-file-csv text-4xl text-slate-400 group-hover:text-indigo-500 transition-colors"></i>
                    <p class="text-slate-600 font-medium">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå CSV</p>
                    <p class="text-slate-400 text-sm">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå cleaned_sales.csv ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Date ‡πÅ‡∏•‡∏∞ Sales_Amount</p>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="space-y-6">
            <!-- Chart 1: Observed -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-slate-700 mb-4 border-l-4 border-blue-500 pl-3">1. Observed Data (‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏à‡∏£‡∏¥‡∏á)</h3>
                <div class="h-64">
                    <canvas id="observedChart"></canvas>
                </div>
            </div>

            <!-- Chart 2: Trend -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-slate-700 mb-4 border-l-4 border-amber-500 pl-3">2. Trend Component (‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß)</h3>
                <div class="h-64">
                    <canvas id="trendChart"></canvas>
                </div>
                <p class="text-xs text-slate-400 mt-2 text-right">*‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ Moving Average (4 Weeks)</p>
            </div>

            <!-- Chart 3: Seasonal -->
            <div class="bg-white p-6 rounded-xl shadow-sm">
                <h3 class="text-lg font-bold text-slate-700 mb-4 border-l-4 border-teal-500 pl-3">3. Seasonal & Residual (‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô/‡∏§‡∏î‡∏π‡∏Å‡∏≤‡∏•)</h3>
                <div class="h-64">
                    <canvas id="seasonalChart"></canvas>
                </div>
                <p class="text-xs text-slate-400 mt-2 text-right">*‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° (Observed - Trend)</p>
            </div>
        </div>

        <!-- Summary & Insights -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Key Findings -->
            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-indigo-500">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-lightbulb text-yellow-500"></i> ‡∏Ç‡πâ‡∏≠‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö‡∏´‡∏•‡∏±‡∏Å (Key Findings)
                </h3>
                <div id="keyFindings" class="space-y-3 text-slate-600">
                    <p class="italic text-slate-400">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                </div>
            </div>

            <!-- Summary Stats -->
            <div class="bg-white p-6 rounded-xl shadow-sm border-t-4 border-pink-500">
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-clipboard-list text-pink-500"></i> ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (Summary)
                </h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 uppercase font-bold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <p id="totalSales" class="text-xl font-bold text-indigo-600">-</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 uppercase font-bold">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</p>
                        <p id="bestWeek" class="text-xl font-bold text-emerald-600">-</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 uppercase font-bold">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</p>
                        <p id="avgWeeklySales" class="text-xl font-bold text-blue-600">-</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 uppercase font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                        <p id="totalWeeks" class="text-xl font-bold text-slate-700">-</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Footer -->
        <div class="flex flex-col md:flex-row justify-end items-center gap-4 mt-8 pb-10 no-print">
            <button onclick="window.print()" class="w-full md:w-auto px-6 py-3 bg-white border border-slate-300 text-slate-700 font-semibold rounded-lg shadow-sm hover:bg-slate-50 hover:text-indigo-600 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-print"></i> Print Report
            </button>
            <button onclick="exportToCSV()" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 hover:shadow-lg transition-all flex items-center justify-center gap-2">
                <i class="fas fa-file-download"></i> Export CSV
            </button>
        </div>

    </div>

    <script>
        // --- Mock Data (10 Rows for Layout Testing) ---
        const mockData = `Transaction_ID,Date,Customer_ID,Product_Category,Sales_Amount,Region
TXN-01997,14/04/2024,C-0049,Sports,24903.5,Bangkok
TXN-01998,17/11/2024,C-0019,Sports,42341.0,Bangkok
TXN-01999,01/08/2024,C-0368,Electronics,29987.0,Bangkok
TXN-02000,04/10/2024,C-0903,Electronics,49601.0,Chonburi
TXN-01991,12/01/2024,C-0112,Fashion,15000.0,Phuket
TXN-01992,19/01/2024,C-0223,Beauty,8500.0,Chiang Mai
TXN-01993,25/02/2024,C-0334,Home,12300.0,Bangkok
TXN-01994,10/03/2024,C-0445,Electronics,34000.0,Khon Kaen
TXN-01995,05/04/2024,C-0556,Sports,21000.0,Phuket
TXN-01996,20/05/2024,C-0667,Fashion,18900.0,Bangkok`;

        // --- Global Variables ---
        let processedData = []; // Store weekly data: { weekStart, sales, trend, seasonal }
        let observedChartInstance = null;
        let trendChartInstance = null;
        let seasonalChartInstance = null;

        // --- Initialization ---
        window.addEventListener('DOMContentLoaded', () => {
            // Load mock data initially for layout check
            processData(mockData, 'Mock Data (10 Rows)');
        });

        // --- File Handling ---
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                processData(e.target.result, file.name);
            };
            reader.readAsText(file);
        }

        // --- Core Data Processing ---
        function processData(csvText, sourceName) {
            const rows = csvText.trim().split('\n').slice(1); // Skip header
            const rawData = [];

            // 1. Parse CSV
            rows.forEach(row => {
                // Handle potential comma in quoted fields (simple logic)
                const cols = row.split(','); 
                if (cols.length < 5) return;

                // Format: TXN-ID, Date(DD/MM/YYYY), Customer_ID, Category, Amount, Region
                const dateStr = cols[1];
                const amount = parseFloat(cols[4]);

                if (dateStr && !isNaN(amount)) {
                    const [day, month, year] = dateStr.split('/');
                    const dateObj = new Date(`${year}-${month}-${day}`);
                    
                    if (!isNaN(dateObj)) {
                        rawData.push({ date: dateObj, amount: amount });
                    }
                }
            });

            if (rawData.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV");
                return;
            }

            // 2. Resample to Weekly (Start of Week - Monday)
            // Sort by Date first
            rawData.sort((a, b) => a.date - b.date);

            const weeklyMap = new Map();

            rawData.forEach(item => {
                // Find Monday of the week
                const d = new Date(item.date);
                const day = d.getDay();
                const diff = d.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
                const monday = new Date(d.setDate(diff));
                monday.setHours(0,0,0,0);
                
                const key = monday.toISOString().split('T')[0]; // YYYY-MM-DD
                
                if (!weeklyMap.has(key)) {
                    weeklyMap.set(key, 0);
                }
                weeklyMap.set(key, weeklyMap.get(key) + item.amount);
            });

            // Convert Map to Array and Sort
            let weeklyData = Array.from(weeklyMap, ([date, sales]) => ({ date, sales }));
            weeklyData.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Fill missing weeks (optional but good for time series) - skipping for simplicity to handle mock data gaps better
            
            // 3. Decompose (Trend & Seasonal)
            // Trend: Simple Moving Average (Window = 4 weeks)
            const windowSize = 4;
            processedData = weeklyData.map((item, index, arr) => {
                // Calculate Trend (Centered-ish or Trailing)
                // Let's use simple trailing for clarity or centered if possible. 
                // Using simple trailing 4-point average for stability at ends
                let sum = 0;
                let count = 0;
                
                // Try centered window: current and previous 3
                // Or simplified: Average of current + prev 3
                for (let i = 0; i < windowSize; i++) {
                    if (arr[index - i]) {
                        sum += arr[index - i].sales;
                        count++;
                    }
                }
                
                const trend = count > 0 ? sum / count : item.sales; // Fallback to sales if no history
                
                // Seasonal/Residual = Observed - Trend
                const seasonal = item.sales - trend;

                return {
                    date: item.date,
                    sales: item.sales,
                    trend: parseFloat(trend.toFixed(2)),
                    seasonal: parseFloat(seasonal.toFixed(2))
                };
            });

            // 4. Update UI
            updateDashboard(processedData, sourceName);
        }

        function updateDashboard(data, sourceName) {
            const labels = data.map(d => formatDateTH(d.date));
            const observed = data.map(d => d.sales);
            const trend = data.map(d => d.trend);
            const seasonal = data.map(d => d.seasonal);

            // Destroy old charts
            if (observedChartInstance) observedChartInstance.destroy();
            if (trendChartInstance) trendChartInstance.destroy();
            if (seasonalChartInstance) seasonalChartInstance.destroy();

            // Create Charts
            observedChartInstance = createChart('observedChart', labels, observed, '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á (Observed)', '#3b82f6', 'rgba(59, 130, 246, 0.1)');
            trendChartInstance = createChart('trendChart', labels, trend, '‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏° (Trend)', '#f59e0b', 'rgba(245, 158, 11, 0.1)', true); // Smooth line for trend
            seasonalChartInstance = createChart('seasonalChart', labels, seasonal, '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (Seasonal)', '#14b8a6', 'rgba(20, 184, 166, 0.1)');

            // Calculate Stats
            const total = observed.reduce((a, b) => a + b, 0);
            const avg = total / data.length;
            
            // Find best week
            const maxSales = Math.max(...observed);
            const bestWeekIndex = observed.indexOf(maxSales);
            const bestWeekDate = labels[bestWeekIndex];

            // Render Stats
            document.getElementById('totalSales').innerText = total.toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
            document.getElementById('avgWeeklySales').innerText = avg.toLocaleString('th-TH', { style: 'currency', currency: 'THB' });
            document.getElementById('bestWeek').innerText = bestWeekDate;
            document.getElementById('totalWeeks').innerText = data.length + " ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå";

            // Key Findings Logic
            let trendDirection = "‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß";
            const firstTrend = trend[0];
            const lastTrend = trend[trend.length - 1];
            const trendDiff = ((lastTrend - firstTrend) / firstTrend) * 100;
            
            if (trendDiff > 5) trendDirection = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô (Upward Trend)";
            else if (trendDiff < -5) trendDirection = "‡∏•‡∏î‡∏•‡∏á (Downward Trend)";

            const volatility = Math.max(...seasonal) - Math.min(...seasonal);

            const findingsHTML = `
                <ul class="list-disc list-inside space-y-2 text-sm">
                    <li><strong class="text-indigo-600">‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Trend):</strong> ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏°‡∏µ‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á <b>${trendDirection}</b> (${trendDiff.toFixed(1)}% ‡∏à‡∏≤‡∏Å‡∏ï‡πâ‡∏ô‡∏ä‡πà‡∏ß‡∏á)</li>
                    <li><strong class="text-emerald-600">‡∏à‡∏∏‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (Peak):</strong> ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ <b>${bestWeekDate}</b> (${maxSales.toLocaleString()} ‡∏ö‡∏≤‡∏ó)</li>
                    <li><strong class="text-teal-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏±‡∏ô‡∏ú‡∏ß‡∏ô (Volatility):</strong> ‡∏ä‡πà‡∏ß‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏à‡∏£‡∏¥‡∏á‡∏Å‡∏±‡∏ö‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${volatility.toLocaleString()} ‡∏ö‡∏≤‡∏ó</li>
                </ul>
            `;
            document.getElementById('keyFindings').innerHTML = findingsHTML;
        }

        // --- Helper: Create Chart ---
        function createChart(canvasId, labels, data, label, color, bgColor, smooth = false) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: color,
                        backgroundColor: bgColor,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        fill: true,
                        tension: smooth ? 0.4 : 0.1 // Smooth line for Trend
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.raw.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { borderDash: [2, 4], color: '#e5e7eb' },
                            ticks: {
                                font: { family: "'Sarabun', sans-serif" },
                                callback: value => value.toLocaleString()
                            }
                        },
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { family: "'Sarabun', sans-serif", size: 10 },
                                maxTicksLimit: 12 // Limit labels to avoid clutter
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        // --- Helper: Format Date ---
        function formatDateTH(dateStr) {
            const d = new Date(dateStr);
            // Format: 14 ‡πÄ‡∏°.‡∏¢. 67
            const options = { day: 'numeric', month: 'short', year: '2-digit', year: 'numeric' };
            // Adjust year for Thai Buddhist calendar if needed, but keeping standard for now
            return d.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
        }

        // --- Export to CSV ---
        function exportToCSV() {
            if (processedData.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å");
                return;
            }

            // Headers
            let csvContent = "data:text/csv;charset=utf-8,Week_Start_Date,Sales_Observed,Trend,Seasonal_Residual\n";

            // Rows
            processedData.forEach(row => {
                csvContent += `${row.date},${row.sales},${row.trend},${row.seasonal}\n`;
            });

            // Download Trigger
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "workshop11_weekly_decomposition.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>
